name: 'nuitka tk windows'
on:
  push:
    branches:
      - 'nuitka-none'
    paths-ignore:
      - '.vscode/**'
      - 'doc/**'
      - '*.md'
      
  workflow_dispatch:

jobs:
  build_windows_x64:
    runs-on: windows-2022
    
    env:
      PYTHONWARNDEFAULTENCODING: 0
      APPNAME: PyGlossaryTk
      DIST_DIR: dist.nuitka.tk
      MAIN_SCRIPT: main.py
      
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          fetch-tags: true
          ref: master

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          architecture: 'x64'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install nuitka
          python -m pip install beautifulsoup4 biplist colorize_pinyin html5lib libzim lxml marisa-trie mistune polib prompt-toolkit pygments pymorphy2 python-idzip python-romkan-ng pyyaml tqdm xxhash 
          python -m pip install --extra-index-url https://glowinthedark.github.io/python-lzo/ python-lzo
          # FIXME:::TODO::: python -m pip install --extra-index-url https://glowinthedark.github.io/pyicu-build PyICU
          # python -m pip install https://github.com/cgohlke/pyicu-build/releases/download/v2.15/pyicu-2.15-cp313-cp313-win_amd64.whl

      - name: Patch Files
        shell: python
        run: |
          import os
          from shutil import copy
          from pathlib import Path
          
          # Copy main script
          copy(os.getenv("MAIN_SCRIPT"), os.getenv("APPNAME"))
          
          # Remove __init__.py if exists
          init_file = Path('__init__.py')
          if init_file.exists():
              init_file.unlink()
          
          # Patch argparse_main.py
          argparse_file = Path('pyglossary/ui/argparse_main.py')
          if argparse_file.exists():
              content = argparse_file.read_text(encoding='utf8')
              content = content.replace('default="auto"', 'default="tk"')
              argparse_file.write_text(content, encoding='utf8')
          
          # Patch runner.py
          runner_file = Path('pyglossary/ui/runner.py')
          if runner_file.exists():
              content = runner_file.read_text(encoding='utf8')
              content = content.replace('"gtk", "tk", "web"', '"tk", "gtk", "web"')
              runner_file.write_text(content, encoding='utf8')

      - name: Nuitka Build
        run: |
          python -m nuitka --standalone --assume-yes-for-downloads --follow-imports --windows-console-mode=disable --windows-icon-from-ico=res\pyglossary.ico --enable-plugin=tk-inter --include-package=pyglossary --include-module=tkinter --include-module=lzo --include-module=pymorphy2 --include-module=_json --include-module=lxml --include-module=polib --include-module=yaml --include-module=bs4 --include-module=html5lib --include-module=icu --include-module=colorize_pinyin --include-package-data=pyglossary --include-data-files=about=about --include-data-files=_license-dialog=_license-dialog --noinclude-custom-mode=unittest:nofollow --noinclude-pytest-mode=nofollow --noinclude-setuptools-mode=nofollow --nofollow-import-to=pyglossary.ui.ui_gtk --nofollow-import-to=pyglossary.ui.ui_gtk4 --nofollow-import-to=pyglossary.ui.ui_qt --nofollow-import-to=gi --nofollow-import-to=icu --nofollow-import-to=gtk --nofollow-import-to=pyqt4 --nofollow-import-to=pyqt5 --nofollow-import-to=pyqt6 --nofollow-import-to=*.tests --output-dir=${{ env.DIST_DIR }} --output-filename=pyglossary.exe main.py

      - name: Copy Assets
        shell: python
        run: |
          from pathlib import Path
          import shutil
          import sys
          import os
          
          dist_dir = os.getenv("DIST_DIR")
          app_name = os.getenv("APPNAME")
          
          if not dist_dir or not app_name:
              print('Missing environment variables')
              sys.exit(1)
          
          dist_path = Path(dist_dir)
          print(f'DIST_DIR={dist_path}, APPNAME={app_name}')
          
          # Find the actual build directory (Nuitka creates a subdirectory)
          target_dirs = list(dist_path.glob("main.dist"))
          if not target_dirs:
              print(f'No build directory found in {dist_path}')
              sys.exit(1)
          
          target_path = target_dirs[0]
          sources = ["about", "AUTHORS", "_license-dialog", "config.json", "plugins-meta", "help", "res", "pyglossary"]
          
          for source in sources:
              src = Path(source)
              if not src.exists():
                  print(f"Warning: {src} not found, skipping")
                  continue
              
              try:
                  if src.is_dir():
                      dest = target_path / src.name
                      if dest.exists():
                          shutil.rmtree(dest)
                      shutil.copytree(src, dest, symlinks=True, ignore_dangling_symlinks=True)
                  else:
                      shutil.copy2(src, target_path)
                  print(f"Copied {src} to {target_path}")
              except Exception as e:
                  print(f"Failed to copy {src}: {e}")
          
          print("Asset copying completed")

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          include-hidden-files: true
          name: ${{ github.event.repository.name }}-${{ runner.os }}-${{ runner.arch }}-${{ github.sha }}
          path: ${{ env.DIST_DIR }}/**/*
