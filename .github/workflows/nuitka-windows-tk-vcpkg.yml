name: 'nuitka tk windows msvc compiler gpt-oss'
on:
  push:
    branches: ['nuitka-none']
    paths-ignore:
      - '.vscode/**'
      - 'doc/**'
      - '*.md'
      - '.github/**'

  workflow_dispatch:

jobs:
  build_windows_x64:
    strategy:
      matrix:
        python-version:
          # - "3.10"
          # - "3.11"
          - "3.13"
        # os: [macos-latest, ubuntu-latest, windows-latest]
        os: [windows-2022]
    runs-on: ${{ matrix.os }}

    env:
      PYTHONWARNDEFAULTENCODING: true
      APPNAME: PyGlossaryTk
      DIST_DIR: dist.nuitka.tk
      MAIN_SCRIPT: main.py
      RESOURCE_DIR: "resources"
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
      - name: Checkâ€‘out repository
        uses: actions/checkout@v4
        with:
          submodules: true
          # Number of commits to fetch, ootb only 1 commit
          # 0 = all history for all branches and tags. (needed for git describe)
          fetch-depth: 0
          fetch-tags: true
          ref: master

      # ------------------------------------------------------------------
      # 1ï¸âƒ£  Setup MSVC (x64) â€“ provides compiler & linker
      # ------------------------------------------------------------------
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ------------------------------------------------------------------
      # 2ï¸âƒ£  Install Python 3.13 (x64) â€“ weâ€™ll use uv for everything else
      # ------------------------------------------------------------------
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          # x86, x64, or arm64
          architecture: 'x64'
          # python-version-file: ".python-version"

      # ------------------------------------------------------------------
      # 3ï¸âƒ£  Install uv
      # ------------------------------------------------------------------
      # - name: Install uv
      #   # https://docs.astral.sh/uv/guides/integration/github/#caching
      #   uses: astral-sh/setup-uv@v6

      # ------------------------------------------------------------------
      # 4ï¸âƒ£  Create venv
      # ------------------------------------------------------------------
      - name: Create and activate venv
        shell: pwsh
        run: |
          python3 -m venv .venv
          .\env\Scripts\Activate.ps1

      # ------------------------------------------------------------------
      # 5ï¸âƒ£  Bootstrap vcpkg and install C/C++ dependencies
      # ------------------------------------------------------------------
      - name: Bootstrap vcpkg & install ICU + LZO
        shell: pwsh
        run: |
          $vcpkg = Join-Path $env:VCPKG_INSTALLATION_ROOT "vcpkg.exe"
          # Build the libs we need â€“ they will be placed under .\installed\x64-windows\
          & $vcpkg install icu lzo --clean-after-build --triplet $env:VCPKG_DEFAULT_TRIPLET

      # ------------------------------------------------------------------
      # 6ï¸âƒ£  Export VCPKG_ROOT so that pip can find the libraries
      # ------------------------------------------------------------------
      - name: Set VCPKG_ROOT env var
        shell: pwsh
        run: |
          echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV
          echo "PATH=$env:VCPKG_INSTALLATION_ROOT;$env:PATH" >> $env:GITHUB_ENV

      # ------------------------------------------------------------------
      # 7ï¸âƒ£  Install Python wheels in vcpkg env
      # ------------------------------------------------------------------
      - name: Install Python dependencies (with vcpkg env)
        shell: pwsh
        run: |
          $vcpkg = Join-Path $env:VCPKG_INSTALLATION_ROOT "vcpkg.exe"
          & $vcpkg env "pip install nuitka && pip install beautifulsoup4 biplist colorize_pinyin html5lib libzim lxml marisa-trie mistune polib prompt_toolkit pygments pymorphy2 python-idzip python-romkan-ng pyyaml setuptools tqdm wheel xxhash && pip install pyicu && pip install --no-binary :all: python-lzo" --triplet $env:VCPKG_DEFAULT_TRIPLET
            
      # - name: Install Python dependencies (with vcpkg env)
      #   shell: pwsh
      #   run: |
      #     $vcpkg = Join-Path $env:VCPKG_INSTALLATION_ROOT "vcpkg.exe"
      #     & $vcpkg env 'pwsh -Command "uv pip install nuitka; uv pip install beautifulsoup4 biplist colorize_pinyin html5lib libzim lxml marisa-trie mistune polib prompt_toolkit pygments pymorphy2 python-idzip python-romkan-ng pyyaml setuptools tqdm wheel xxhash; uv pip install pyicu; uv pip install --no-binary :all: python-lzo"' --triplet $env:VCPKG_DEFAULT_TRIPLET
      
      # - name: Install Python dependencies (with vcpkg env)
      #   shell: pwsh
      #   run: |
      #     $vcpkg = Join-Path $env:VCPKG_INSTALLATION_ROOT "vcpkg.exe"
      #     $installScript = @"
      #     echo '--- Installing Python packages inside vcpkg env ---'
      #     uv pip install nuitka
      #     uv pip install beautifulsoup4 biplist colorize_pinyin html5lib libzim lxml marisa-trie mistune polib prompt_toolkit pygments pymorphy2 python-idzip python-romkan-ng pyyaml setuptools tqdm wheel xxhash
      #     uv pip install pyicu
      #     uv pip install --no-binary :all: python-lzo
      #     echo '--- Successfully installed all dependencies ---'
      #     "@
      #     & $vcpkg env --triplet $env:VCPKG_DEFAULT_TRIPLET -- pwsh -c $installScript

      # ------------------------------------------------------------------
      # 8ï¸âƒ£  Patch sources (unchanged)
      # ------------------------------------------------------------------
      - name: Patch sources
        shell: python
        run: |
          import os, sys
          from pathlib import Path
          try:
              Path(os.getenv("APPNAME")).write_bytes(Path(os.getenv("MAIN_SCRIPT")).read_bytes())
              Path('__init__.py').unlink()
              p = Path('pyglossary/ui/argparse_main.py')
              p.write_text(p.read_text().replace('default="auto"', 'default="tk"'), encoding='utf8')
              p = Path('pyglossary/ui/runner.py')
              p.write_text(p.read_text().replace('"gtk", "tk", "web"', '"tk", "gtk", "web"'), encoding='utf8')
              p = Path('.venv/lib/python3.13/site-packages/nuitka/plugins/standard/TkinterPlugin.py')
              p.write_text(p.read_text().replace('self.tk_inter_version in ("8.5", "8.6")', 'self.tk_inter_version in ("8.5", "8.6", "9.0")'), encoding='utf8')
          except Exception as e:
              print(str(e))

      # ------------------------------------------------------------------
      # 9ï¸âƒ£  Nuitka build
      # ------------------------------------------------------------------
      - name: Nuitka build
        shell: cmd
        run: |
          uv run nuitka --standalone \
            --assume-yes-for-downloads \
            --plugin-enable=dll-files \
            --plugin-enable=anti-bloat \
            --follow-imports \
            --windows-console-mode=disable \
            --windows-icon-from-ico=res\pyglossary.ico \
            --enable-plugin=tk-inter \
            --include-package=pyglossary \
            --include-module=tkinter \
            --include-module=lzo \
            --include-module=pymorphy2 \
            --include-module=_json \
            --include-module=lxml \
            --include-module=polib \
            --include-module=biplist \
            --include-module=prompt_toolkit \
            --include-module=yaml \
            --include-module=bs4 \
            --include-module=html5lib \
            --include-module=icu \
            --include-module=colorize_pinyin \
            --include-package-data=pyglossary \
            --include-data-files=about=about \
            --include-data-files=_license-dialog=_license-dialog \
            --include-data-files=_license-dialog=license-dialog \
            --noinclude-custom-mode=unittest:nofollow \
            --noinclude-pytest-mode=nofollow \
            --noinclude-setuptools-mode=nofollow \
            --nofollow-import-to=pyglossary.ui.ui_gtk \
            --nofollow-import-to=pyglossary.ui.ui_gtk4 \
            --nofollow-import-to=pyglossary.ui.ui_qt \
            --nofollow-import-to=gi \
            --nofollow-import-to=gtk \
            --nofollow-import-to=pyqt4 \
            --nofollow-import-to=pyqt5 \
            --nofollow-import-to=pyqt6 \
            --nofollow-import-to=*.tests \
            --plugin-disable=pyqt5 main.py \
            --output-dir="${{ env.DIST_DIR }}" \
            --output-filename=pyglossary.exe

      # ------------------------------------------------------------------
      # ðŸ”§  Copy assets (unchanged)
      # ------------------------------------------------------------------
      - name: Copy assets
        shell: python
        run: |
          from pathlib import Path, PurePath
          import shutil, sys, os

          dist_dir = os.getenv("DIST_DIR")
          app_name = os.getenv("APPNAME")

          if not dist_dir or not app_name:
              print('missing env vars')
              sys.exit(0)

          target_path = Path(dist_dir)/"main.dist"
          print(f'TARGET_PATH={target_path}, APPNAME={app_name}')

          sources = ["about", "AUTHORS", "_license-dialog", "config.json",
                     "plugins-meta", "help", "res", "pyglossary"]

          if not target_path.exists():
              print(f'missing target dir {target_path.absolute()}')
              sys.exit(0)

          for source in sources:
              src = Path(source)
              try:
                  if src.is_dir():
                      shutil.copytree(src, target_path / src.name,
                                      dirs_exist_ok=True, symlinks=True,
                                      ignore_dangling_symlinks=True)
                  else:
                      shutil.copy(src, target_path, follow_symlinks=False)
                  print(f"Copied {src} -> {target_path / src.name}")
              except FileNotFoundError:
                  print(f"Missing {src}")
              except PermissionError:
                  print(f"No access {src}")
              except Exception as e:
                  print(f"Failed {src}: {e}")

          print("Done")

      # ------------------------------------------------------------------
      # ðŸ“¦  Upload artifacts (unchanged)
      # ------------------------------------------------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          include-hidden-files: true
          name: ${{ github.event.repository.name }}-${{ runner.os }}-${{ runner.arch }}-${{ github.sha }}
          path: |
            ${{ env.DIST_DIR }}/main.dist/**/*

